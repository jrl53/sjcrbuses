<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Milata-Contribuir</title>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="libs/gmaps.js"></script>
  <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="css/examples.css" />
</head>
<body>
  <h1>Ayudanos a trazar una ruta</h1>
  <div class="row">
    <div class="span11">
      <div id="map"></div>
    </div>
    <div class="span6">
	
		<form action="" method="post">
			
			<textarea readonly name="coords"></textarea>
			<textarea readonly id="stopstext"></textarea>
			<input id="startButton" value="Start Tracking" type="button">
			<input id="stopButton" value="Stop" type="button">
			<input id= "addButton" value="Add Stop" type="button">
                        <input id="resetButton" value="Reset Trip" type="button">
			<input id="submitButton" disabled="disabled" type="submit" onclick="this.form.action = this.form.t_action.value;">
		</form>
      
    </div>
  </div>


<script type="text/javascript">
	var map;
	var path = new Array();
    $(document).ready(function(){
      map = new GMaps({
        el: '#map',
        lat: 9.965466,
        lng: -84.058571,
        click: function(e){
          console.log(e);
        }
      });
      
      resetTrip();
	
	$('#startButton').click(function(){
            startTracking();
            $('#startButton').attr('disabled','disabled');
            $('#submitButton').attr('disabled','disabled');
	});
        
        $('#stopButton').click(function(){
            stopTrip();
            $('#startButton').removeAttr('disabled');
            $('#submitButton').removeAttr('disabled');
        });
        
        $('#resetButton').click(function(){
            if (!confirm('Esta acción borrará el viaje completo sin enviar al servidor. Desea continuar?')){
                return false;
            }
            resetTrip();
            stopTrip();
            $('startButton').removeAttr('disabled');
            
        });
        
        $('#addButton').click(function(){
            addStop();
        });
        
    });
	var ta = document.querySelector('textarea');
	var ts = document.querySelector('#stopstext');
	var lt = 0;
	var ls = false;
	var track = false;
	var watchID;

	
        function resetTrip() {
            localStorage.setItem('trip', '');
            ta.value = '';
            ts.value = '';
            map.removeMarkers();
            map.removePolylines();
            return true;
        }
	
	function stopTrip() {
		navigator.geolocation.clearWatch(watchID);
		return true;
	}
	
	function startTracking() {
		track = true;
		watchID = navigator.geolocation.watchPosition(
			function(position) {
				var now = new Date().getTime();
				if (ls != 1 || now - lt > 1000) {
					ta.value += position.coords.longitude + ',' + position.coords.latitude + '\n';
					localStorage.setItem('trip', ta.value);
					
					path.push([position.coords.latitude, position.coords.longitude]);
					drawlines();
					updatePosition(position.coords.latitude, position.coords.longitude);
					lt = now;
					ls = 1;
				}
			},
			function() {
				var now = new Date().getTime();
				if (ls != 0 || now - lt > 1000) {
					ta.value += now + ' // fail\n';
					localStorage.setItem('trip', ta.value);
					lt = now;
					ls = 0;
				}
			},
			{
				enableHighAccuracy: true,
				maximumAge: 60000,
				timeout: 15000
			}
		);
	}
	
	function drawlines() {
		map.removePolylines();
		map.drawPolyline({
        strokeColor: '#131540',
        path: path,
        strokeOpacity: 0.6,
        strokeWeight: 6
      });
	}
	
	function updatePosition(lat,lng){
		map.setCenter(lat, lng);
	}
	
	function addStop() {
		navigator.geolocation.getCurrentPosition(
			function(position){
				ts.value += 'STOP' + position.coords.longitude + ',' + position.coords.latitude + '\n';
				//localStorage.setItem('stops', 
				map.addMarker({
					lat: position.coords.latitude,
					lng: position.coords.longitude,
					title: 'Stop'
				});
			},
                        function(){
                            alert('WWWAAAAHHHH');
                        }      
		);
	}
	</script>
</body>
</html>