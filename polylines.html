<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GMaps.js &mdash; Polylines</title>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="libs/gmaps.js"></script>
  <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="css/examples.css" />
  <script type="text/javascript">
    var map;
	var path = new Array()
    $(document).ready(function(){
      map = new GMaps({
        el: '#map',
        lat: 9.965466,
        lng: -84.058571,
        click: function(e){
          console.log(e);
        }
      });
	
	

      map.drawPolyline({
        path: path,
        strokeColor: '#131540',
        strokeOpacity: 0.6,
        strokeWeight: 6
      });
    });
  </script>
  
  
  
</head>
<body>
  <h1>GMaps.js &mdash; Polylines</h1>
  <div class="row">
    <div class="span11">
      <div id="map"></div>
    </div>
    <div class="span6">
	
		<form action="" method="post">
			
			<textarea readonly name="coords"></textarea>
			<textarea readonly id="stopstext"></textarea>
			<input value="Start Tracking" type="button" onclick="startTracking();this.disabled=true;">
			<input value="Stop Trip" type="button" onclick="resetTrip();">
			<input value="Use Server" type="button" onclick="this.form.t_action.value = 'savetrip.php';">
			<input type="submit" onclick="this.form.action = this.form.t_action.value;">
			<input value="Add Stop" type="button" onclick="addStop();">
		</form>
      <p>The path of the polyline is defined by an array of array of two (latitude and longitude).</p>
    </div>
  </div>
</body>

<script>
	var ta = document.querySelector('textarea');
	var ts = document.querySelector('#stopstext');
	var lt = 0;
	var ls = false;
	var track = false;
	var watchID;

	(function() {
		var tr = localStorage.getItem('trip');
		if (tr != '' && tr != null) {
			ta.value = tr + '\n';
		}
	})();
	function addHeader() {
		ta.value += '-- tracking started: ' + (new Date().toString()) + '\n';
		ta.value += (new Date().getTime()) + ' // start\n';
		localStorage.setItem('trip', ta.value);
	}
	function resetTrip() {
		if (!confirm('Are you sure you want to clear your trip?'))
			return false;
		localStorage.setItem('trip', '');
		ta.value = '';
		navigator.geolocation.clearWatch(watchID);
		addHeader();
	}
	
	function startTracking() {
		track = true;
		addHeader();
		watchID = navigator.geolocation.watchPosition(
			function(position) {
				var now = new Date().getTime();
				if (ls != 1 || now - lt > 1000) {
					ta.value += position.coords.longitude + ',' + position.coords.latitude + '\n';
					localStorage.setItem('trip', ta.value);
					
					path.push([position.coords.latitude, position.coords.longitude]);
					drawlinestest();
					updatePosition(position.coords.latitude, position.coords.longitude);
					lt = now;
					ls = 1;
				}
			},
			function() {
				var now = new Date().getTime();
				if (ls != 0 || now - lt > 1000) {
					ta.value += now + ' // fail\n';
					localStorage.setItem('trip', ta.value);
					lt = now;
					ls = 0;
				}
			},
			{
				enableHighAccuracy: true,
				maximumAge: 60000,
				timeout: 15000
			}
		);
	}
	
	function drawlinestest() {
		map.drawPolyline({
        path: path,
        strokeColor: '#131540',
        strokeOpacity: 0.6,
        strokeWeight: 6
      });
	}
	
	function updatePosition(lat,lng){
		map.setCenter(lat, lng);
	}
	
	function addStop() {
		navigator.geolocation.getCurrentPosition(
			function(position){
				ts.value += 'STOP' + position.coords.longitude + ',' + position.coords.latitude + '\n';
				//localStorage.setItem('stops', 
				map.addMarker({
					lat: position.coords.latitude,
					lng: position.coords.longitude,
					title: 'Stop'
				});
			}
		
		);
	}
	
	function showError(error)
	  {
	  switch(error.code) 
		{
		case error.PERMISSION_DENIED:
		  alert("User denied the request for Geolocation.")
		  break;
		case error.POSITION_UNAVAILABLE:
		  alert( "Location information is unavailable.")
		  break;
		case error.TIMEOUT:
		  alert(  "The request to get user location timed out.")
		  break;
		case error.UNKNOWN_ERROR:
		  alert(  "An unknown error occurred.")
		  break;
		}
	  }

</script>

</html>